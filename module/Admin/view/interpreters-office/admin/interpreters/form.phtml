<?php
use Zend\Form\Element;
/**
 *  module/Admin/view/interpreters-office/admin/people/form.phtml
 *  view script for rendering people create|update form
 */
$this->headTitle($this->title);
$this->headLink()->appendStylesheet($this->basePath('css/jquery-bootstrap-datepicker.css'));
$this->headScript()
        ->appendFile($this->basePath('js/lib/modernizr-custom.js'))
        ->appendFile($this->basePath('js/lib/jquery-ui/jquery-ui.min.js'));

if ($this->errorMessage) : ?>
<div class="alert alert-danger"><?php echo $this->errorMessage ?></div>
<?php
return;
endif;
$formAction = strstr($this->title, 'add') ? $this->url('interpreters/add')
    : $this->url('interpreters/edit', ['id' => $this->id ]);

$form = $this->form;
$form->add([
    'name' => 'submit',
    'type' => 'Zend\Form\Element\Submit',
     'attributes' => ['value' => 'save','class'=>'btn btn-success btn-lg'],
])->setAttribute('method', 'post')
   ->setAttribute('action', $formAction)
   ->setAttribute('class', 'form-horizontal')    ;
?>
<div class="center-block" style="max-width:800px"><!-- wrapper -->
<h2><?php echo $this->title ?></h2>
fuck you?
<?php

$form->prepare();
$fieldset = $form->get('interpreter');
echo $this->form()->openTag($form);?>


<!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation"><a href="#contact" aria-controls="contact" role="tab" data-toggle="tab">contact &amp; languages</a></li>
    <li role="presentation"><a href="#administrative" aria-controls="administrative" role="tab" data-toggle="tab">administrative</a></li>
  </ul>


  <!-- Tab panes -->
  <div class="tab-content" style="padding-top: 1em">
    <div role="tabpanel" class="tab-pane" id="contact">

    <?php
    $hat = $fieldset->get('hat');?>
        <div class="form-group">
            <label class="control-label col-sm-3"><?php echo $hat->getLabel()?></label>
            <div class="col-sm-9"><?php echo $this->formSelect($hat),$this->formElementErrors($hat) ?>            
            </div>
        </div>
    <?php
     // text inputs
    foreach (['lastname','firstname','middlename','email','officePhone','mobilePhone'] as $elementName) :
        $element = $fieldset->get($elementName);?>
    <div class="form-group">
        <label class="control-label col-sm-3"><?php echo $element->getLabel()?></label>
        <div class="col-sm-9"><?php echo $this->formText($element),$this->formElementErrors($element) ?>            
        </div>
    </div>
    <?php
    endforeach;
    $active = $fieldset->get('active');?>
    <div class="form-group">
        <label class="control-label col-sm-3"><?php echo $active->getLabel()?></label>
        <div class="col-sm-9"><?php echo $this->formCheckbox($active),$this->formElementErrors($active) ?>            
        </div>
     </div>
    <div class="form-group">
        <label class="control-label col-sm-3">languages</label>
        <div class="col-sm-9"><?php 
        $languageSelect = $fieldset->get('language-select'); 
        echo $this->formSelect($languageSelect),$this->formElementErrors($languageSelect) ;
        //$this->formSelect($fieldset->get('interpreter-languages'));
        $shit = $fieldset->get('interpreter-languages');
        echo $this->formSelect($shit);
        echo $this->formElementErrors($shit);
        ?> 
        </div>
        <!-- wrapper for nested grid // border:1px solid #afd9ee; -->
        <div class="form-group" id="interpreter-languages" style="clear:both">
            <div class="col-sm-3 col-sm-offset-4 languages-header">language</div>
            <div class="col-sm-2 languages-header">fed certification</div>
            <div class="col-sm-3"></div>     
    <?php 
        $entity = $form->getObject();
        $interpreterLanguages = $entity->getInterpreterLanguages();
        $fed_certification_options = ['' => 'N/A', 1 => 'yes', 0 => 'no', ];
        
        if (count($interpreterLanguages)) :     
            $i = 0;            
            foreach ($interpreterLanguages as $ilanguage) :
                $language = $ilanguage->getLanguage();
                $language_id = $language->getId();
                $certifiable = $language->isFederallyCertified();
                $fed_certification_options[''] = $certifiable ? '' : 'N/A';           
            ?>
            <div class="col-sm-3 col-sm-offset-4 interpreter-language language-name" id="language-<?php echo $language_id?>"><?php 
                echo $this->escapeHtml($ilanguage->getLanguage());
                // language and interpreter ids as hidden inputs

               ?><input type="hidden" name="interpreter[interpreter-languages][<?php echo $i?>][language_id]" value="<?php echo $language_id; ?>">
              <?php if (false): // not using this ?>
                <input type="hidden" name="interpreter[interpreter-languages][<?php echo $i?>][interpreter_id]" value="<?php echo $this->id?>">
              <?php endif ?>
            </div>
            <div class="col-sm-2 interpreter-language language-fed-certification"><?php 
               $element = new Element\Select("interpreter[interpreter-languages][$i][federalCertification]");
               $element->setValueOptions($fed_certification_options)
                       ->setValue($ilanguage->getFederalCertification())->setAttribute('class', 'form-control');
               $disabled = false;
                if (! $ilanguage->isCertifiable()) {
                   $element->setAttribute("disabled","disabled");
                   $disabled = true;
               }
               echo $this->formSelect($element);
               if ($disabled) : // keep the validators happy ?>
                <input type="hidden" name="interpreter[interpreter-languages][<?php echo $i ?>][federalCertification]" value="">
               <?php endif;
            ?></div>
            <div class="col-sm-3 interpreter-language remove-language">
                <button title="remove from this interpreter's working languages" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove"></span><span class="sr-only">remove</span></button></div>
            <?php  
            $i++; 
            endforeach;
        endif;
    ?>              
       </div><!-- /grid wrapper -->   

    </div><!--  /tab pane -->
    </div>
    <div role="tabpanel" class="tab-pane" id="administrative">

    other form elements  here<br>
    <?php $element = $fieldset->get('fingerprint_date');?>
   <div class="form-group">
        <label class="control-label col-sm-3"><?php echo $element->getLabel()?></label>
        <div class="col-sm-9"><?php echo $this->formElement($element),$this->formElementErrors($element) ?>            
        </div>
    </div>
    


    </div><!--  /tab pane -->
    <div class="form-group">
        <div class="col-sm-offset-3 col-sm-9">
        <?php
        $csrf = $form->get('csrf');
        echo $this->formHidden($csrf),$this->formElementErrors($csrf) ;
        echo $this->formHidden($fieldset->get('id'));
        echo $this->formSubmit($form->get('submit'));?></div>
    </div>    
  </div><!-- wrapper for centering -->


 


<?php 
echo $this->form()->closeTag(); ?>
</div><!-- /wrapper -->


<script type="text/javascript">
    
/** 
 * attach event listeners
 * 
 * @todo live in its own file ?
 * @todo add a button to the select and attach listener to its 'click' event
 * instead of 'change' event on select menu 
 * @todo refactor so this function is not so long and monolithic
 * 
 */

$(function(){
    $('a[href="#contact"]').trigger('click');
    console.log("triggered click on contact tab. see bootstrap doc re how to do it right");
    
    if (! Modernizr.inputtypes.date) {
        //$('#fingerprint_date').datepicker();
    }
    
    var select = $('#language-select');    
    select.on("change",function(){
        // console.log("change event on select element");
        if (! (parseInt(select.val()) > 0)) {           
            return;
        }

        var option = select.children(':selected');
        var language_id = option.attr('value');
        if ($('#language-' + language_id).length) {
            // then it already exists
            return;
        }
        // gather some data for injecting into the elements
        var index = $('.language-name').length;
        var languageName = option.text();
        var certifiable = option.data().certifiable;
        //console.warn("DEBUG: language name is "+languageName+ " and certifiable is " + (certifiable ? "true" : "false"));
        // build the three div elements, and stick into an array
        var divs = [];
        divs[0] = $('<div>')
                .addClass("col-sm-3 col-sm-offset-4 interpreter-language language-name")
                .attr({id : 'language-'+language_id})
                .text(languageName)
                .append(
                    $('<input>').attr({
                        type  : "hidden",
                        name  : "interpreter[interpreter-languages]["+index+"][language_id]",
                        value : language_id
                    })
                );
        var certificationSelectElement = $('<select>')
                        .addClass("form-control")
                        .attr({name: "interpreter[interpreter-languages]["+index+"][federalCertification]"});
                        
        if (certifiable) {
            certificationSelectElement
                    .append($("<option>").attr({value:""}).text(""))
                    .append('<option value="1">yes</option><option value="0">no</option>');
        } else {
            certificationSelectElement.append($("<option>")
                    .attr({value:"",selected : "selected"})
                    .text("N/A")
                ).attr({disabled : "disabled"});
                    
        }
        divs[1] = $('<div>').addClass("col-sm-2 interpreter-language language-fed-certification")
                .append(certificationSelectElement);
        if (! certifiable) {
            // with select element disabled, this has to be present 
            // so that it will validate
            divs[1].append(
                 $('<input>').attr({
                     type : "hidden",
                     name : certificationSelectElement.attr("name"),
                     value : ""
                 })
            );
        }
        divs[2] = $('<div>').addClass("col-sm-3 interpreter-language remove-language").html(
                '<button title="remove from this interpreter\'s working languages" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove"></span><span class="sr-only">remove</span></button>'
            );
        // finally, append it all to the interpreter-languages div
        $('#interpreter-languages').append(divs);
        // reset the language-select
        select.val($('#language-select option:first').attr("value"));
        
        
    });
    // remove the language (3 divs) when the x is clicked
    $('#interpreter-languages').on("click", "div.remove-language",function(event){
        event.preventDefault();
        var n = $(this).index();
        // there must be a more elegant way to select the current element plus 
        // its two previous siblings
        $(this).prevAll().addBack().slice(n-2,n+1).slideUp(
                function(){$(this).remove();}
        );
        
    });
    // testing
    // $('#hat').val(3); $('#lastname').val("Doink"); $('#firstname').val("Boink");
    // select.children(':contains("French")').attr({selected:"selected"}).trigger("change");
});
</script>
