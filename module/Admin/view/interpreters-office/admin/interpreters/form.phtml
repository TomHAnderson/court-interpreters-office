<?php
use Zend\Form\Element;
/**
 *  module/Admin/view/interpreters-office/admin/people/form.phtml
 *  view script for rendering people create|update form
 */
$this->headTitle($this->title);
if ($this->errorMessage) : ?>
<div class="alert alert-danger"><?php echo $this->errorMessage ?></div>
<?php
return;
endif;
$formAction = strstr($this->title, 'add') ? $this->url('interpreters/add')
    : $this->url('interpreters/edit', ['id' => $this->id ]);

$form = $this->form;
$form->add([
    'name' => 'submit',
    'type' => 'Zend\Form\Element\Submit',
     'attributes' => ['value' => 'save','class'=>'btn btn-success btn-lg'],
])->setAttribute('method', 'post')
   ->setAttribute('action', $formAction)
   ->setAttribute('class', 'form-horizontal')    ;
?>
<div class="center-block" style="max-width:800px"><!-- wrapper -->
<h2><?php echo $this->title ?></h2>
<?php

$form->prepare();
$fieldset = $form->get('interpreter');
echo $this->form()->openTag($form);?>
<?php
$hat = $fieldset->get('hat');?>
    <div class="form-group">
        <label class="control-label col-sm-3"><?php echo $hat->getLabel()?></label>
        <div class="col-sm-9"><?php echo $this->formSelect($hat),$this->formElementErrors($hat) ?>            
        </div>
    </div>
<?php
 // text inputs
foreach (['lastname','firstname','middlename','email','officePhone','mobilePhone'] as $elementName) :
    $element = $fieldset->get($elementName);?>
<div class="form-group">
    <label class="control-label col-sm-3"><?php echo $element->getLabel()?></label>
    <div class="col-sm-9"><?php echo $this->formText($element),$this->formElementErrors($element) ?>            
    </div>
</div>
<?php
endforeach;
$active = $fieldset->get('active');?>
<div class="form-group">
    <label class="control-label col-sm-3"><?php echo $active->getLabel()?></label>
    <div class="col-sm-9"><?php echo $this->formCheckbox($active),$this->formElementErrors($active) ?>            
    </div>
 </div>

<div class="form-group">
    <label class="control-label col-sm-3">languages</label>
    <div class="col-sm-9"><?php 
    $languageSelect = $fieldset->get('language-select'); 
    echo $this->formSelect($languageSelect),$this->formElementErrors($languageSelect) ?> 
    </div>
    <!-- wrapper for nested grid // border:1px solid #afd9ee; -->
    <div class="row" id="interpreter-languages" style="clear:both">
        <div class="col-sm-3 col-sm-offset-4 languages-header">language</div>
        <div class="col-sm-2 languages-header">fed certification</div>
        <div class="col-sm-3"></div>     
<?php 
    $entity = $form->getObject();
    $interpreterLanguages = $entity->getInterpreterLanguages();
    $fed_certification_options = ['' => 'N/A', 1 => 'yes', 0 => 'no', ];
    
    if (count($interpreterLanguages)) :     
        $i = 0;            
        foreach ($interpreterLanguages as $ilanguage) :
            $language_id = $ilanguage->getLanguage()->getId();
        ?>
        <div class="col-sm-3 col-sm-offset-4 interpreter-language language-name" id="language-<?php echo $language_id?>"><?php 
            echo $this->escapeHtml($ilanguage->getLanguage());
            // language and interpreter ids as hidden inputs
           ?><input type="hidden" name="interpreter[interpreterLanguages][<?php echo $i?>][language]" value="<?php echo $language_id; ?>"><?php 
           ?><input type="hidden" name="interpreter[interpreterLanguages][<?php echo $i?>][interpreter]" value="<?php echo $this->id?>">
        </div>
        <div class="col-sm-2 interpreter-language language-fed-certification"><?php 
           $element = new Element\Select("interpreter[interpreterLanguages][$i][federalCertification]");
           $element->setValueOptions($fed_certification_options)->setValue($ilanguage->getFederalCertification())->setAttribute('class', 'form-control');
           echo $this->formSelect($element);
        ?></div>
        <div class="col-sm-3 interpreter-language remove-language">
            <button title="remove from this interpreter's working languages" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove"></span><span class="sr-only">remove</span></button></div>
        <?php  
        $i++; 
        endforeach;
    endif;
?>              
   </div><!-- /grid wrapper -->   

</div>
<div class="form-group">
    <div class="col-sm-offset-3 col-sm-9">
    <?php
    $csrf = $form->get('csrf');
    echo $this->formHidden($csrf),$this->formElementErrors($csrf) ;
    echo $this->formHidden($fieldset->get('id'));
    echo $this->formSubmit($form->get('submit'));?></div>
</div>
<?php echo $this->form()->closeTag(); ?>
</div><!-- /wrapper -->
<script type="text/javascript">
    
/** dynamically add a language. @todo live in its own file ? */

$(function(){
    var select = $('#language-select');    
    select.on("change",function(){
        console.log("change event on select element");
        if (! (parseInt(select.val()) > 0)) {
            return;
        }
        console.warn( parseInt(select.val()) > 0  );
        var option = select.children(':selected');
        var language_id = option.attr('value');
        if ($('#language-' + language_id).length) {
            // then it already exists
            return;
        }
        // the next index is the number of these elements
        var index = $('.language-name').length;
        var languageName = option.text();
        var certifiable = option.data().certifiable;
        
        var interpreter_id = $('input[name="interpreter[id]"]').val();
        var divs = [];
        divs[0] = $('<div>')
                .addClass("col-sm-3 col-sm-offset-4 interpreter-language language-name")
                .attr({id : language_id})
                .text(languageName)
                .append(
                    $('<input>').attr({
                        type  : "hidden",
                        name  : "interpreter[interpreterLanguages]["+index+"][language]",
                        value : language_id
                    })
                )
                .append(
                     $('<input>').attr({
                        type  : "hidden",
                        name  : "interpreter[interpreterLanguages]["+index+"][interpreter]",
                        value : interpreter_id
                    })
                );
        /*<select name="interpreter[interpreterLanguages][0][federalCertification]" class="form-control"><option value="">N/A</option>
            <option value="1" selected="selected">yes</option><option value="0">no</option></select>*/
        var certificationSelectElement = $('<select>')
                        .addClass("form-control")
                        .attr({name: "interpreter[interpreterLanguages]["+index+"][federalCertification]"});
                        
        if (certifiable) {
            certificationSelectElement
                    .append($("<option>").attr({value:""}).text(""))
                    .append('<option value="1" selected="selected">yes</option><option value="0">no</option>');
        } else {
            certificationSelectElement.append($("<option>")
                    .attr({value:"",selected : "selected"})
                    .text("N/A")
                ).attr({disabled : "disabled"});
                    
        }
        divs[1] = $('<div>').addClass("col-sm-2 interpreter-language language-fed-certification")
                .append(certificationSelectElement);
        divs[2] = $('<div>').addClass("col-sm-3 interpreter-language remove-language").html(
                '<button title="remove from this interpreter\'s working languages" class="btn btn-info btn-xs"><span class="glyphicon glyphicon-remove"></span><span class="sr-only">remove</span></button>'
            );
        //console.log(divs); 
        $('#interpreter-languages').append(divs);
        
    });
    // when language select menu item is chosen, add it to the list
    /*
    select.on("change",function(){
        if (! select.val()) {
            return;
        }
        var option = select.children(':selected');
        var language = option.text();
        if (list.children(':contains("'+language+'")').length) {
            return;
        }
        createLanguageItem(option).appendTo(list);
        select.val('');
    });   
    }
    */

    //  testing
    $('#hat').val(3);
    $('#lastname').val("Doink");
    $('#firstname').val("Boink");
    // select.children(':contains("French")').attr({selected:"selected"}).trigger("change");
});
/**
 * helper function to create li element
 * not currently in use!
 * @param option jQuery with one <option> element
 * @returns jQuery with one <li> element
 */
createLanguageItem = function(option)
{
    var li = $('<li>').addClass('list-group-item');
    var input = $('<input>').attr({
            type: "hidden",
            name: languageElementName,
            value: option.attr('value')
        });
    return li.text(option.text()).append(input);
};
</script>