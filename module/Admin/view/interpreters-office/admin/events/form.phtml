<?php
use InterpretersOffice\Admin\Form\View\Helper\InterpreterElementCollection;
use InterpretersOffice\Admin\Form\View\Helper\DefendantNameElementCollection;

$this->headTitle('admin | schedule | '.$this->layout()->action);
$this->headLink()
        ->appendStylesheet($this->basePath('css/jquery-ui.min.css'));
$this->headScript()
        ->appendFile($this->basePath('js/lib/modernizr-custom.js'))
        ->appendFile($this->basePath('js/lib/jquery-ui/jquery-ui.js'))
        ->appendFile($this->basePath('js/lib/moment/min/moment.min.js'))
        ->appendFile($this->basePath('js/event-form.js'));

$messenger = $this->flashMessenger();
if ($messenger->hasErrorMessages()) :
    echo $messenger->render('error', ['alert','alert-warning',], false);
endif;

if ($this->errorMessage) : ?>
<div class="alert alert-danger"><?php echo $this->errorMessage ?></div>
<?php
return;
endif;
$form = $this->form;
$form->setAttribute('class','form-event mx-auto')
        ->setAttribute('style','max-width:950px');
$form->add([
    'name' => 'submit',
    'type' => 'Zend\Form\Element\Submit',
    'attributes' => ['value' => 'save','class'=>'btn btn-success btn-lg'],
])->setAttribute('method', 'post');

$form->prepare();
$fieldset = $form->get('event');

foreach (['date','time','end_time','submission_time', 'submission_date'] as $time) :
    if (! $fieldset->has($time)) : continue; endif;
    $element = $fieldset->get($time);
    $value = $element->getValue();

    if ($value instanceof \DateTime) { 
        $format = strstr($time, 'time') ? 'g:i a':'Y-m-d' ;
        $element->setValue($value->format($format));
        continue;
    }
    if (2 == substr_count($value, ':')) {
        $fieldset->get($time)->setValue(substr($value,0,5));
    }
endforeach;

$hatElement = $fieldset->get('anonymousSubmitter');
if ($this->hat_id):
    $hatElement->setValue($hat_id);
    $submitterElement = $fieldset->get('submitter');
    $submitter = $submitterElement->getValue();
    $options = $submitterElement->getValueOptions();
    if ($submitter &&  1 <= sizeof($options)) :
        $data = $fieldset->getObjectManager()
            ->getRepository('InterpretersOffice\Entity\Person')
            ->getPersonOptions($hat_id);
        array_unshift($options, $data);
        $submitterElement->setValueOptions($data);
    endif;    
endif;
$parent = $fieldset->get('parent_location')->getValue();
$location_element = $fieldset->get('location');
$location_options = $location_element->getValueOptions();
if ($parent && sizeof($location_options) <= 1) :
    $repo = $fieldset->getObjectManager()
        ->getRepository('InterpretersOffice\Entity\Location');
    $data = $repo->getChildLocationValueOptions($parent);
    $location_options = $location_element->getValueOptions();
    array_unshift($location_options, $data);           
    $location_element->setValueOptions($location_options[0]);                
endif;

// temporarily, let's just set this here
$config = ['end_time' => true];
?>
<div id="slideout-toggle" style="display:none;position:absolute;left:0;z-index:100;min-width:22rem" class="card border ml-5 bg-light">
    <div class="card-header">
         <button type="button" title="close" class="btn btn-default close float-right m-1" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="card-title">defendant names</h4>
        <!-- instructions (when search results are non-zero?)
        <h6 class="card-subtitle text-muted">select a name to add to this event</h6> -->
    </div>
    <div class="card-body pl-3 mb-0">
        <div class="card-text result">
        </div>
    </div>
    <div class="mt-1 mb-2 mx-auto text-center">
        <button title="add a new defendant name" id="btn-add-defendant-name" class="btn btn-primary btn-sm">
            <span aria-hidden="true" class="fas fa-plus"></span> new defendant name
        </button>
    </div>
</div>
<h2 class="text-center mb-3"><?php echo (string)$this->navigation('default')->breadcrumbs() ;?></h2>
<?php
echo $this->form()->openTag($form); ?>
<div class="form-row">
    <div class="col-md-6"><!-- left side -->
    <?php
        foreach (['date','time','eventType','judge', ] as $elementName) :
            $element = $fieldset->get($elementName);
           ?>
        <div class="form-group form-row my-2">
            <?php
            if ('time' == $elementName && $config['end_time']):
                $end_time = $fieldset->get('end_time'); ?>
                <label for="<?php echo $element->getAttribute('id')?>" class="col-sm-4 col-form-label pr-1"><?php echo $element->getLabel()?></label>
                <div class="col-sm-1 col-form-label pr-1">from</div>
                <div class="col-sm-7"><?php echo $this->formElement($element),$this->formElementErrors($element)?></div>
                <label for="<?php echo $end_time->getAttribute('id')?>" class="offset-sm-4 col-sm-1 col-form-label  pr-1">to</label>
                <div class="col-sm-7"><?php  echo $this->formElement($end_time),$this->formElementErrors($end_time)?></div>
            <?php else: ?>
            <label for="<?php echo $element->getAttribute('id')?>" class="col-sm-4 col-form-label pr-1"><?php echo $element->getLabel()?></label>
            <div class="col-sm-8"><?php echo $this->formElement($element),
                         $this->formElementErrors($element);?></div>
            <?php endif; ?>
        </div>
        <?php endforeach; $element = $fieldset->get('parent_location');?>
        <div class="form-group form-row my-2">
            <label for="<?php echo $element->getAttribute('id')?>" class="col-sm-4 col-form-label pr-1"><?php echo $element->getLabel()?></label>
            <div class="col-sm-8"><?php
                    echo $this->formElement($element),
                         $this->formElement($location_element),
                         $this->formElementErrors($element) ?>
            </div>
        </div>
    <?php foreach (['docket', 'comments','admin_comments']  as $elementName) :
        $element = $fieldset->get($elementName); ?>
        <div class="form-group form-row my-2">
            <label class="col-sm-4 col-form-label pr-1" for="<?php echo $element->getAttribute('id') ?>"><?= $element->getLabel() ?></label>
            <div class="col-sm-8"><?php
                echo $this->formElement($element), $this->formElementErrors($element) ?>
            </div>
        </div>
    <?php endforeach; ?>
    </div><!-- /left side -->
    <div class="col-md-6"><!-- right side -->
        <?php $element = $fieldset->get('language'); ?>
        <div class="form-group form-row my-2">
            <label class="col-sm-4 col-form-label pr-1" for="<?php echo $element->getAttribute('id') ?>"><?= $element->getLabel() ?></label>
            <div class="col-sm-8"><?php
                echo $this->formElement($element), $this->formElementErrors($element) ?>
            </div>
        </div>
        <div class="form-group form-row my-2">
            <label class="col-sm-4 col-form-label pr-1" for="interpreter-select">interpreters</label>
            <div class="col-sm-8">
                <div class="input-group">
                    <?php echo $this->formElement($fieldset->get('interpreter-select'));?>
                        <button class="btn btn-info fas fa-plus" title="assign the selected interpreter to this event" type="button" id="btn-add-interpreter"><span class="sr-only">add</span></button>
                 </div>
                <ul style="margin-top: .5em" id="interpreters-assigned" class="list-group interpreters-assigned">
                    <?php
                    /** THIS IS AwKWARD. re-think and start over? */
                    if  ($this->interpreters) {
                        $helper = (new InterpreterElementCollection())->setView($this);
                        echo $helper->fromPost($this->interpreters);
                    } else {
                         $interpreters = $form->getObject()->getInterpreterEvents();
                        if ($interpreters->count()) {
                            $helper = (new InterpreterElementCollection())->setView($this);
                            echo $helper($fieldset->get('interpreterEvents'));
                        }
                    }
                    ?>
                </ul>

            </div>
        </div>
        <div class="form-group form-row my-2">
            <label class="col-form-label pr-1 col-sm-4" for="defendant-search">defendants</label>
            <div class="col-sm-8">
                <div class="input-group">
                    <?php echo $this->formElement($fieldset->get('defendant-search'));?>
                     <button class="btn btn-info fas fa-search" title="search for defendant names" type="button" id="btn-defendant-search"><span class="sr-only">search</span></button>
                     <?php echo $this->formSelect($fieldset->get('defendantNames')); ?>
                </div>
                <ul style="margin-top: .5em" id="defendant-names" class="list-group defendant-names">
                <?php                
                if ($this->defendantNames) {
                    foreach ($this->defendantNames as $id => $name) {
                        echo $this->defendantName($id,$name);
                    }
                } else {
                    $names = $form->getObject()->getDefendantNames()->toArray();
                    //echo "DEBUG: # deft names is ". count($names);
                    foreach ($names as $nameObject) {
                        $name = $nameObject->getSurNames() . ', ' . $nameObject->getGivenNames();
                        echo $this->defendantName($nameObject->getId(),$name);
                    }
                }?>
                </ul>
            </div>
        </div>
        <div class="form-group form-row my-2">
            <label class="col-form-label pr-1 col-sm-4" for="hat">submitted by</label>
            <div class="col-sm-8">
            <?php
                echo $this->formElement($fieldset->get('anonymousSubmitter'));?>
            <?php $element = $fieldset->get('submitter');
                echo $this->formElement($element), $this->formElementErrors($element);
            ?>
            </div>
        </div>
        <div class="form-group form-row my-2">
            <label class="col-form-label pr-1 col-sm-4" for="submission_date">submitted on</label>
            <div class="col-sm-8">
            <?php $element = $fieldset->get('submission_date');
                  echo $this->formElement($element),$this->formElementErrors($element);?>
            </div>
            <label class="col-form-label pr-1 col-sm-4 submission-time" for="submission_time">at</label>
            <div class="col-sm-8 submission-time">
            <?php $element = $fieldset->get('submission_time');
                echo $this->formElement($element),$this->formElementErrors($element);?>
            </div>
        </div>
        <?php $element = $fieldset->get('cancellationReason');?>
        <div class="form-group form-row my-2">
            <label class="col-form-label pr-1 col-sm-4" for="<?php echo $element->getAttribute('id')?>">cancellation</label>
            <div class="col-sm-8"><?php            
                  echo $this->formElement($element);?>
            <?php echo $this->formElementErrors($element);?>
            </div>
        </div>
    </div><!-- /col-md-6 -->
    <div class="col-12 text-center">
        <?php
            $csrf = $form->get('csrf');
            echo $this->formHidden($fieldset->get('is_anonymous_judge'));
            echo $this->formHidden($fieldset->get('anonymousJudge'));
            echo $this->formHidden($csrf),$this->formElementErrors($csrf) ;
            echo $this->formHidden($fieldset->get('id'));
            if ($form->has('modified')) {
                $element = $form->get('modified');
                $value = $element->getValue();
                if (is_object($value)) {
                    $element->setValue($value->format('Y-m-d H:i:s'));
                }
                echo $this->formHidden($element);
            }
            echo $this->formSubmit($form->get('submit'));?>
    </div>
</div>
<?php echo $this->form()->closeTag();?>
