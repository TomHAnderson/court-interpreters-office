<?php
use InterpretersOffice\Admin\Form\View\Helper\InterpreterElementCollection;
use InterpretersOffice\Admin\Form\View\Helper\DefendantNameElementCollection;

$this->headTitle('admin | events | '.$this->layout()->action);
$this->headLink()
        ->appendStylesheet($this->basePath('css/jquery-ui.min.css'));
$this->headScript()
        ->appendFile($this->basePath('js/lib/modernizr-custom.js'))
        ->appendFile($this->basePath('js/lib/jquery-ui/jquery-ui.js'))
        ->appendFile($this->basePath('js/lib/moment/min/moment.min.js'))
        ->appendFile($this->basePath('js/event-form.js'))
        ;
if ($this->errorMessage) : ?>
<div class="alert alert-danger"><?php echo $this->errorMessage ?></div>
<?php
return;
endif;
$form = $this->form; 
$form->setAttribute('class','form-horizontal form-event');
$form->add([
    'name' => 'submit',
    'type' => 'Zend\Form\Element\Submit',
    'attributes' => ['value' => 'save','class'=>'btn btn-success btn-lg'],
])->setAttribute('method', 'post');
?>
<h2><?php echo $this->navigation('default')->breadcrumbs() ?></h2>
<?php
$form->prepare();
$fieldset = $form->get('event');
// for testing
if (false) {
    echo "FUCKING SHIT? .........<br>";
    $fieldset->get('time')->setValue('10:00:00');
    $fieldset->get('date')->setValue('2017-08-15');
   // $fieldset->get('judge')->setValue(1);
    $fieldset->get('eventType')->setValue(1);
    $fieldset->get('language')->setValue(62);
    $fieldset->get('parent_location')->setValue(1);
    $fieldset->get('interpretersAssigned')->populateValues([  
   ['interpreter'=> 117] 
]);
}
/** @todo put all this logic somewhere else? */
$event = $form->getObject();

// if location is set and has a parent, set parent_location element
$location = $event->getLocation();
if ($location && $parentLocation = $location->getParentLocation()) {
    $fieldset->get('parent_location')->setValue($parentLocation->getId());
}
// if submitter !== NULL, set anonymousSubmitter element = hat_id of submitter
if (null !== $event->getSubmitter()) {
    $hat = $event->getSubmitter()->getHat();
    $fieldset->get('anonymousSubmitter')->setValue($hat->getId());
}
// judge element value needs to be an integer
$judge = $fieldset->get('judge')->getValue();
if (is_object($judge)) {
   $fieldset->get('judge')->setValue($judge->getId());
}
// temporarily, set this here
$config = ['end_time' => true];
echo $this->form()->openTag($form);  
?>
<div class="col-sm-6"><!-- left side -->
    <div class="row">
        <?php foreach (['date','time','eventType','judge', ] as $elementName) : 
            $element = $fieldset->get($elementName); ?>
            <div class="form-group">
                <label class="control-label col-sm-4" for="<?= $element->getAttribute('id') ?>"><?= $element->getLabel() ?></label>
                <?php
                if ('time' == $elementName && $config['end_time']):
                    // this looks shitty and needs more work.
                    // the "time" element looks like shit in chrome.
                    // the inline css doesn't work for smaller viewports
                ?>
                <div class="col-sm-3"  style="padding-right:0px">
                    <?php echo $this->formElement($element),$this->formElementErrors($element);?>
                    <!-- <input class="form-control time" name="time" id="time"> -->
                </div><label class="control-label col-sm-2" style="text-align:center;margin:0;" for="end_time">to</label>
                <div class="col-sm-3" style="padding-left:0px">
                    <?php $element = $fieldset->get('end_time');
                    echo $this->formElement($element),$this->formElementErrors($element);?>
                    <!-- <input class="form-control time" id="end_time" name="to"> -->
                </div>
                <?php
                    else: 
                  ?><div class="col-sm-8"><?php
                    echo $this->formElement($element), $this->formElementErrors($element);
                    ?></div><?php
                    endif;
                ?>
            </div>
        <?php endforeach;  $element = $fieldset->get('parent_location')?>
            <div class="form-group">
                <label class="control-label col-sm-4" for="<?= $element->getAttribute('id') ?>"><?= $element->getLabel() ?></label>
                <div class="col-sm-8"><?php 
                    echo $this->formElement($element), 
                         $this->formElement($fieldset->get('location')),
                         $this->formElementErrors($element) ?>
                </div>
            </div>
        <?php foreach (['language','docket', 'comments','admin_comments']  as $elementName) : 
            $element = $fieldset->get($elementName); ?>
            <div class="form-group">
                <label class="control-label col-sm-4" for="<?= $element->getAttribute('id') ?>"><?= $element->getLabel() ?></label>
                <div class="col-sm-8"><?php 
                    echo $this->formElement($element), $this->formElementErrors($element) ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>
<div class="col-sm-6"><!-- right side -->
    <div class="row"><!--  style="background-color: yellow" -->
        <div class="form-group">
            <label class="control-label col-sm-4" for="interpreter-select">interpreters</label>
            <div class="col-sm-8">
                <?php echo $this->formElement($fieldset->get('interpreter-select'));?>
                <ul style="margin-top: .5em" id="interpreters-assigned" class="list-group interpreters-assigned">
                <?php 
                $collection = $fieldset->get('interpretersAssigned'); 
                $helper = (new InterpreterElementCollection())->setView($this);
                echo $helper($collection);
                ?>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-4" for="defendant-search">defendants</label>
            <div class="col-sm-8">
                <?php echo $this->formElement($fieldset->get('defendant-search'));?>
                <ul style="margin-top: .5em" id="defendant-names" class="list-group defendant-names">
                <?php                
                $collection = $fieldset->get('defendantsEvent'); 
                $helper = (new DefendantNameElementCollection())->setView($this);
                echo $helper($collection);
                ?>
                </ul>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-4" for="hat">submitted by</label>
            <div class="col-sm-8">
            <?php 
                  echo $this->formElement($fieldset->get('anonymousSubmitter'));?>
            <?php echo $this->formElement($fieldset->get('submitter'));?>                
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-4" for="submission_date">submitted on</label>
            <div class="col-sm-8">
            <?php 
                  echo $this->formElement($fieldset->get('submission_date'));?>                
            </div>
            <label class="control-label col-sm-4 submission-time" for="submission_time">at</label>
            <div class="col-sm-8 submission-time">
            <?php echo $this->formElement($fieldset->get('submission_time'));?>                
            </div>
        </div>

        <?php foreach ([] as $elementName) : $element = $fieldset->get($elementName); ?>
            <div class="form-group">
            <label class="control-label col-sm-4" for="defendant-search"><?php echo $element->getLabel() ?></label>
                <div class="col-sm-8"><?= $this->formElement($element) ?><?= $this->formElementErrors($element) ?></div>
            </div>
        <?php endforeach; ?>
    </div><!-- /.row -->
</div><!-- /right side -->
<div class="row">
    <div style="margin-top:1em" class="form-group">
        <div class="col-sm-12" style="text-align: center;">

            <?php
            $csrf = $form->get('csrf');
            //echo $this->formHidden($fieldset->get('is_anonymous_judge'));
            //echo $this->formHidden($fieldset->get('anonymousJudge'));
            echo $this->formHidden($csrf),$this->formElementErrors($csrf) ;
            echo $this->formHidden($fieldset->get('id'));
            if ($fieldset->has('modified')) {
                $element = $fieldset->get('modified');
                $value = $element->getValue();
                if (is_object($value)) {
                    $element->setValue($value->format('Y-m-d H:i:s'));
                }
                echo $this->formHidden($element);   
            }
            echo $this->formSubmit($form->get('submit'));?>
        </div>
    </div><!-- / .form-group -->
</div>
<?php echo $this->form()->closeTag(); ?>

